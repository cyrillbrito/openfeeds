# Database Package - Drizzle ORM Rules

This package provides the database layer for OpenFeeds using Drizzle ORM with SQLite3.

## Commands

**From root directory:**

```bash
bun user-db-generate   # Generate user database migrations
bun auth-db-generate   # Generate auth database migrations
```

**From packages/db:**

```bash
bun user-db-generate   # Generate user schema migrations only
bun auth-db-generate   # Generate auth schema migrations only
```

## Architecture

**Database Setup:**

- **Primary DB:** SQLite3 for production
- **User Schema:** RSS feeds, articles, tags, read status
- **Auth Schema:** Better Auth tables (users, sessions, etc.)
- **Separate Configs:** `drizzle.config.ts` (user) and `drizzle-auth.config.ts` (auth)

## Schema Management

**User Schema Tables:**

```typescript
// Example table definitions
export const feedsTable = sqliteTable('feeds', {
  id: integer('id').primaryKey({ autoIncrement: true }),
  userId: text('user_id').notNull(),
  url: text('url').notNull(),
  title: text('title'),
  // ...
});

export const articlesTable = sqliteTable('articles', {
  id: integer('id').primaryKey({ autoIncrement: true }),
  feedId: integer('feed_id').references(() => feedsTable.id),
  title: text('title').notNull(),
  // ...
});
```

**Auth Schema:**

- Auto-generated by Better Auth CLI
- Handles users, sessions, accounts tables
- Updated via `bun auth-db-generate` command

## Migration Workflow

**Making Schema Changes:**

1. Modify table definitions in user schema files
2. Run `bun user-db-generate` to create migration files
3. Run `bun migrate` to apply migrations
4. Commit both schema changes and migration files

**Auth Schema Updates:**

1. Update Better Auth configuration in `../../apps/server/src/auth.ts`
2. Run `bun auth-db-generate` to regenerate auth schema
3. Migration files are created automatically
4. Run `bun migrate` to apply changes

**Note:** Migrations are run via the `apps/migrator` app which handles both auth and user database migrations.

## Database Connection

**Connection Patterns:**

```typescript
import { articlesTable, db, feedsTable } from '@repo/db';

// Query with proper typing
const userFeeds = await db.select().from(feedsTable).where(eq(feedsTable.userId, userId));

// Insert with validation
const newFeed = await db
  .insert(feedsTable)
  .values({
    userId,
    url: feedUrl,
    title: feedTitle,
  })
  .returning();
```

## Important Guidelines

- Never modify migration files manually
- Always generate migrations after schema changes
- Test migrations on development database first
- Keep user and auth schemas logically separated
- Use proper TypeScript types from schema exports

## Drizzle Features

- SQLite dialect
- Type-safe queries with InferModel
- Migration system with automatic SQL generation
- Relational queries with joins
